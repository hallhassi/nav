<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,user-scalable=no">
  <title>Document</title>
  <style>
    * {
      margin: 0;
      overflow: hidden;
      touch-action: none;
    }

    #debug {
      background: none;
      position: absolute;
      font-size: 2em;
      padding: 1em;
      overflow:none;
    }

    #f {
      font-size: 4em;
      z-index: 2;
    }

    #f,
    #b,
    #cursor {
      position: absolute;
    }

    #f,
    #b {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .x:hover,
    .c:hover,
    .add:hover {
      color: blue;
    }

    .x,
    .c,
    .add {
      flex-shrink: 0;
      height: 1em;
      width: 1em;
      line-height: 1em;
      text-align: center;
      font-family: sans-serif;
      border-radius: 1em;
      cursor: pointer;
    }

    #cursor,
    body {
      outline: 1px solid red;
    }

    .contents {
      flex-grow: 1;
    }

    @media (max-aspect-ratio: 1/1) {
      * {
        background: linear-gradient(to left, rgba(0, 0, 0, .1), rgba(255, 255, 255, .1))
      }

      #f {
        width: 100vw;
      }

      #b {
        height: 100vh;
      }

      #f,
      #b {
        flex-direction: row;
      }
    }

    @media (min-aspect-ratio: 1/1) {
      * {
        background: linear-gradient(to bottom, rgba(0, 0, 0, .1), rgba(255, 255, 255, .1))
      }

      #f {
        height: 100vh;
      }

      #b {
        width: 100vw;
      }

      #f,
      #b {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>

  <div id="debug"></div>

  <div id="f">
    <div id="cursor"></div>
    <div class="x">X</div>
    <div class="contents">
      <div class="texts"></div>
      <div class="images"></div>
    </div>
    <div class="add">+</div>
    <div class="c">C</div>
  </div>

  <div id="b">
    <div class="x">X</div>
    <div class="contents">
      <div class="texts"></div>
      <div class="images"></div>
    </div>
    <div class="add">+</div>
    <div class="c">C</div>
  </div>

  <script>
    function log(x) {
      let div = document.createElement('div')
      div.innerText = x
      debug.insertAdjacentElement('afterbegin', div)
      console.log(x)
    }

    let debug = document.querySelector('#debug')
    let f = document.querySelector('#f')
    let b = document.querySelector('#b')
    let cursor = document.querySelector('#cursor')
    let fx = document.querySelector('#f>.x')
    let bx = document.querySelector('#b>.x')

    function p(g, x) { return parseFloat(getComputedStyle(g)[x]) }
    let fw = p(f, 'width')
    let bw = p(b, 'width')
    let fh = p(f, 'height')
    let bh = p(b, 'height')
    let fe = p(fx, 'width')
    let ff = p(f, 'fontSize')
    let vertical = window.matchMedia("(max-aspect-ratio:1/1)").matches // true if mobile
    orient()
    function orient() {
      if (vertical) {
        cursor.style.height = fh + "px"
        cursor.style.width = fh * window.innerWidth / window.innerHeight + "px"
        f.style.height = "auto"
        f.style.width = "100vw"
        b.style.height = "100vh"
        bw = bh * fw / fh
        b.style.width = bw + "px"
        b.style.fontSize = bh * ff / fh + "px"
      } else {
        cursor.style.width = fw + "px"
        cursor.style.height = fw * window.innerHeight / window.innerWidth + "px"
        f.style.height = "100vh"
        f.style.width = "auto"
        bh = bw * fh / fw
        b.style.height = bh + "px"
        b.style.width = "100vw"
        b.style.fontSize = ff * bw / fw + "px"
      }
    }
    window.addEventListener('resize', reorient)
    function reorient() {
      log('resize')
      let verticalTest = window.matchMedia("(max-aspect-ratio:1/1)").matches
      if (verticalTest !== vertical) {
        if (verticalTest) { // if landscape => mobile
          f.style.top = f.style.left
          f.style.left = 0
          b.style.left = b.style.top
          b.style.top = 0
        } else {
          f.style.left = f.style.top
          f.style.top = 0
          b.style.top = b.style.left
          b.style.left = 0
        }
        vertical = verticalTest
        orient()
      }
    }
    document.addEventListener('touchstart', handleStart)
    document.addEventListener('touchend', handleEnd)
    document.addEventListener('touchmove', handleMove)
    document.addEventListener('touchcancel', handleCancel)
    const ongoingTouches = []

    function handleStart(e) {
      e.preventDefault()
      const touches = e.changedTouches
      for (let i = 0; i < touches.length; i++) {
        log(`touchstart: ${i}.`)
        ongoingTouches.push(copyTouch(touches[i]))
      }
    }
    function handleMove(e) {
      e.preventDefault()
      const touches = e.changedTouches
      for (let i = 0; i < touches.length; i++) {
        const idx = ongoingTouchIndexById(touches[i].identifier)
        log(`continuing touch ${idx}`)
        if (idx >= 0) {
          mouse(ongoingTouches[idx])
          ongoingTouches.splice(idx, 1, copyTouch(touches[i]));  // swap in the new touch record
        } else {
          log('can\'t figure out which touch to continue')
        }
      }
    }
    function handleEnd(e) {
      e.preventDefault()
      const touches = e.changedTouches
      for (let i = 0; i < touches.length; i++) {
        let idx = ongoingTouchIndexById(touches[i].identifier)
        if (idx >= 0) {
          ongoingTouches.splice(idx, 1);
        } else {
          log('can\'t figure out which touch to end')
        }
      }
    }
    function handleCancel(e) {
      e.preventDefault()
      const touches = e.changedTouches
      log('touchCancel.')

      for (let i = 0; i < touches.length; i++) {
        let idx = ongoingTouchIndexById(touches[i].identifier)
        ongoingTouches.splice(idx, 1)
      }
    }
    function copyTouch({ identifier, clientX, clientY }) {
      return { identifier, clientX, clientY }
    }
    function ongoingTouchIndexById(idToFind) {
      for (let i = 0; i < ongoingTouches.length; i++) {
        if (ongoingTouches[i].identifier === idToFind) return i
      }
      return -1;    // not found
    }

    document.addEventListener('mousemove', mouse)
    function mouse(m) {
      let x = m.clientX
      let y = m.clientY
      let be = p(bx, 'width')
      let cw = p(cursor, 'width')
      let ch = p(cursor, 'height')
      let xx = (x - fe / 2) / (fw - fe)
      if (vertical) {
        f.style.top = y - fh / 2 + "px"
        if (x < cw / 2) {
          cursor.style.left = 0
          b.style.left = 0
        }
        else if (x > fw - cw / 2) {
          cursor.style.left = bw - be / 2
          b.style.left = bw - be / 2
        }
        else {
          cursor.style.left = x - p(cursor, 'width') / 2 + "px"
          b.style.left = fw / 2 - (((bw - be) * (x - fe / 2)) / (fw - fe)) - be / 2 + "px"
        }
      } else {
        f.style.left = x - fw / 2 + "px"
        if (y < ch / 2) {
          cursor.style.top = 0
          b.style.top = 0
        }
        else if (y > fh - ch / 2) {
          cursor.style.top = bh - be / 2
          b.style.top = bh - be / 2
        }
        else {
          cursor.style.top = y - p(cursor, 'height') / 2 + "px"
          b.style.top = fh / 2 - (((bh - be) * (y - fe / 2)) / (fh - fe)) - be / 2 + "px"
        }
      }
    }

  </script>
  <script>

  </script>
</body>

</html>
